name: "cloudsmith cleanup"
inputs:
  dry_run:
    default: true
    description: "dry run will print affected packages without actually changing anything"

  repo_name:
    default: "viplive"
    description: "the repo to scan for packages"
  repo_owner:
    default: "topicus-healthcare"
    description: "the owner of the repository"

  pkg_api_fetch_query:
    default: ""
    description: "optional filter query to speed up retrieving packages from the cloudsmith API. Further filtering will be done locally"

  pkg_filter_name_regex:
    default: "^.*$"
    description: "filters are INCLUSIVE; all filters need to be passed. Pass through packages that match this name"
  pkg_filter_format_regex:
    default: "^.*$"
    description: "pass through packages that match this format"
  pkg_filter_versiontag_regex:
    default: "^.+-SNAPSHOT$"
    description: "pass through packages that match this '<type>:<tag value>' combination"
  pkg_filter_versiontag_regex_allow_missing:
    default: "true"
    description: "pass through packages that have no tag at all which would otherwise fail the regex. Useful to remove dangling packages"
  pkg_filter_process_dockerimage_without_parents:
    default: "false"
    description: "docker images without a parent can be processed by the script. this is more risky, because you rely on the docker API always returning correct manifest data, or else images may get deleted incorrectly and corrupt manifests"

  pkg_delete_versiontag_exists_after_days:
    default: "30"
    description: "packages with a tag, that pass through the filter, that have been quarantine for this many days will be deleted permanently"
  pkg_delete_versiontag_missing_after_days:
    default: "30"
    description: "packages without a tag, that pass through the filter, that have been quarantine for this many days will be deleted permanently"

  cloudsmith_username:
    required: true
    description: "Docker username key to use."
  cloudsmith_api_key:
    required: true
    description: "API key to use. Needs permission to list, quarantine and delete packages"
  cloudsmith_docker_registry:
    required: true
    description: "Docker registry to use."

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
    - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
      with:
        node-version: 16
    - run: npm install axios@1.1.3 pretty-bytes@6.0.0
      shell: bash
    # base64 van action.mjs (want shared actions kennen het bestand anders niet)
    #- run: echo "aW1wb3J0IHByZXR0eUJ5dGVzIGZyb20gJ3ByZXR0eS1ieXRlcyc7CmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYW4ob3B0aW9ucykgewoJY29uc3QgY2xvdWRzbWl0aCA9IGF4aW9zLmNyZWF0ZSh7CgkJYmFzZVVSTDogJ2h0dHBzOi8vYXBpLmNsb3Vkc21pdGguaW8vdjEvJywKCQloZWFkZXJzOiB7CgkJCSdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsCgkJCSdYLUFwaS1LZXknOiBvcHRpb25zLmNsb3Vkc21pdGhfYXBpX2tleQoJCX0KCX0pOwoKCWNvbnN0IGNsb3Vkc21pdGhEb2NrZXIgPSBheGlvcy5jcmVhdGUoewoJCWJhc2VVUkw6IGAke29wdGlvbnMuY2xvdWRzbWl0aF9kb2NrZXJfcmVnaXN0cnl9L3YyL2AsCgkJaGVhZGVyczogewoJCQknQWNjZXB0JzogJ2FwcGxpY2F0aW9uL3ZuZC5kb2NrZXIuZGlzdHJpYnV0aW9uLm1hbmlmZXN0Lmxpc3QudjIranNvbicsCgkJCSdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsCgkJCSdBdXRob3JpemF0aW9uJzogYEJhc2ljICR7QnVmZmVyLmZyb20ob3B0aW9ucy5jbG91ZHNtaXRoX3VzZXJuYW1lICsgIjoiICsgb3B0aW9ucy5jbG91ZHNtaXRoX2FwaV9rZXkpLnRvU3RyaW5nKCdiYXNlNjQnKX1gCgkJfQoJfSkKCgkvKioKCSAqIEZldGNoZXMgcGFja2FnZXMgYXN5bmNocm9ub3VzbHkgYnkgcmVjdXJzaXZlbHkgcmV0cmlldmluZyBuZXcgcGFnZXMgYW5kIGNvbmNhdGVuYXRpbmcgdGhlbS4KCSAqCgkgKiBAcGFyYW0gcXVlcnkgRmlsdGVyIHF1ZXJ5IHRvIHNlbmQgdG8gY2xvdWRzbWl0aCwgYWxsb3dzIHNlcnZlcnNpZGUgZmlsdGVyaW5nIHdoaWNoIHNwZWVkcyB1cCBmZXRjaGluZyBpZiB3aXNoZWQuCgkgKiBAcGFyYW0gX3BhZ2UgSGlkZGVuIHByb3BlcnR5IHRvIHJlY3Vyc2l2ZWx5IGluY3JlbWVudCB0aGUgcGFnZSBudW1iZXIuCgkgKiBAcGFyYW0gX3NpemUgSGlkZGVuIHByb3BlcnR5IHRvIGludGVybmFsbHkgY2hhbmdlIHRoZSBmZXRjaCBzaXplLgoJICogQHJldHVybnMge1Byb21pc2U8Kj59IENvbXBsZXRlIGxpc3Qgb2YgcGFja2FnZXMuCgkgKi8KCWNvbnN0IGZldGNoUGFja2FnZXMgPSBhc3luYyAocXVlcnksIF9wYWdlID0gMSwgX3NpemUgPSA1MDApID0+IHsKCQljb25zb2xlLmxvZyhgRmV0Y2hpbmcgcGFnZSAke19wYWdlfS4uLmApOwoKCQljb25zdCByZXNwb25zZSA9IGF3YWl0IGNsb3Vkc21pdGguZ2V0KGBwYWNrYWdlcy8ke29wdGlvbnMucmVwb19vd25lcn0vJHtvcHRpb25zLnJlcG9fbmFtZX0vP3BhZ2U9JHtfcGFnZX0mcGFnZV9zaXplPSR7X3NpemV9JnF1ZXJ5PSR7cXVlcnl9YCkKCQljb25zdCBwYWdlcyA9IHBhcnNlSW50KHJlc3BvbnNlLmhlYWRlcnNbJ3gtcGFnaW5hdGlvbi1wYWdldG90YWwnXSk7CgoJCWNvbnNvbGUubG9nKGBGZXRjaGVkIHBhZ2UgJHtfcGFnZX0vJHtwYWdlc31gKQoKCQlyZXR1cm4gX3BhZ2UgIT09IHBhZ2VzID8gcmVzcG9uc2UuZGF0YS5jb25jYXQoYXdhaXQgZmV0Y2hQYWNrYWdlcyhxdWVyeSwgKytfcGFnZSwgX3NpemUpKSA6IHJlc3BvbnNlLmRhdGE7Cgl9CgoJLyoqCgkgKiBDaGVjayBhIGxpc3Qgb2YgcGFja2FnZXMgZm9yIGNvbXBsZXRlbmVzcywgdG8gYXZvaWQgdW5kZWZpbmVkIGJlaGF2aW9yIGluIHRoaXMgc2NyaXB0LCBzaG91bGQgcHJvcGVydGllcyBiZSBtaXNzaW5nIG9yIHVuZGVmaW5lZC4KCSAqIFRocm93cyBhbiBleGNlcHRpb24gaWYgYSBwYWNrYWdlIGlzIG1pc3NpbmcgZGF0YTsgdGhlIEFQSSB3b3VsZCBiZSB1bnJlbGlhYmxlIGF0IHRoYXQgcG9pbnQuCgkgKiBAcGFyYW0gcGFja2FnZXMgdG8gY2hlY2sKCSAqLwoJY29uc3QgcGFja2FnZXNWYWxpZGF0ZSA9IChwYWNrYWdlcykgPT4gewoJCWNvbnN0IHZhbGlkYXRlRmllbGRzID0gWyd0YWdzJywgJ25hbWUnLCAnZm9ybWF0JywgJ3N0YXR1c19zdHInLCAndXBsb2FkZWRfYXQnLCAnc3RhdHVzX3VwZGF0ZWRfYXQnLCAnaWRlbnRpZmllcl9wZXJtJywgJ3NpemUnLCAnc3VtbWFyeScsICd2ZXJzaW9uJ107CgkJcGFja2FnZXMuZm9yRWFjaChwa2cgPT4gewoJCQl2YWxpZGF0ZUZpZWxkcy5mb3JFYWNoKGYgPT4gewoJCQkJaWYgKCFwa2cuaGFzT3duUHJvcGVydHkoZikgJiYgcGtnW2ZdID09PSB1bmRlZmluZWQpIHsKCQkJCQl0aHJvdyBgJHtKU09OLnN0cmluZ2lmeShwa2cpfVxuXG4hISEhIEFQSSBJUyBVTlNUQUJMRSwgVU5BQkxFIFRPIENPTlRJTlVFOiBwYWNrYWdlICR7cGtnLm5hbWV9IGlzIG1pc3Npbmcgb3IgaGFzIHVuZGVmaW5lZCBmaWVsZDogJHtmfSAhISEhYAoJCQkJfQoJCQl9KQoJCX0pCgl9CgoJLyoqCgkgKiBSZXR1cm5zIGlmIGEgcGFja2FnZSBpcyBzdXBwb3J0ZWQgYnkgdGhlIGNsZWFuZXIuCgkgKi8KCWNvbnN0IHBhY2thZ2VJc1N1cHBvcnRlZCA9IChwa2cpID0+IHsKCQkvKgoJCSAqIFRoZSBjbGVhbmVyIG9ubHkgc3VwcG9ydHMgbWFuaWZlc3QgaW1hZ2VzLCBkdWUgdG8gdGhlIGluYWJpbGl0eSB0byAxMDAlIHNhZmVseSBkZXRlcm1pbmUgd2hpY2ggaW1hZ2VzIGFyZSBwYXJ0IG9mIGEgbWFuaWZlc3QuCgkJICogUmlnaHQgbm93IHlvdSBjYW4gb25seSBkZXRlcm1pbmUgd2hldGhlciBhbiBpbWFnZSBvZiBwYXJ0IG9mIGEgbWFuaWZlc3QsIGJ5IGluc3BlY3RpbmcgYWxsIG1hbmlmZXN0cyBpbiB0aGUgcmVwbyBhbmQgdGhlbiBidWlsZGluZyBhIGxpc3Qgb2YgaGFzaGVzIGFuZCBzZWUgaWYgaXQgY29udGFpbnMgdGhlIGltYWdlLgoJCSAqIFRoaXMgaXMgcmlza3kgYmVjYXVzZSwgc2hvdWxkIHRoaXMgcHJvY2VzcyBmYWlsLCB5b3UnZCBoYXZlIGFuIGluY29tcGxldGUgbGlzdCBhbmQgd2lsbCBiZSBkZWxldGluZyBpbWFnZXMgdGhhdCBhcmUgcGFydCBvZiBhIG1hbmlmZXN0LgoJCSAqIFRoZSBvbmx5IHJlbGlhYmxlIHdheSB0byBkbyBpdCBpcyB0byBub3QgcHVzaCBub24tbWFuaWZlc3QgaW1hZ2VzLCBhc3N1bWUgYWxsIGltYWdlcyBhcmUgcGFydCBvZiBhIG1hbmlmZXN0LCBhbmQgdGhlbiBvbmx5IGRlbGV0aW5nIGltYWdlcyB3aGlsZSBkZWxldGluZyBhIHNwZWNpZmljIG1hbmlmZXN0LgoJCSAqLwoJCXJldHVybiAocGtnLmZvcm1hdCA9PT0gJ2RvY2tlcicgJiYgcGtnLnR5cGVfZGlzcGxheSA9PT0gJ21hbmlmZXN0L2xpc3QnKQoJCQl8fCAocGtnLmZvcm1hdCA9PT0gJ2RvY2tlcicgJiYgcGtnLnR5cGVfZGlzcGxheSA9PT0gJ2ltYWdlJyAmJiAhcGtnLnBhcmVudCAmJiBvcHRpb25zLnBrZ19maWx0ZXJfcHJvY2Vzc19kb2NrZXJpbWFnZV93aXRob3V0X3BhcmVudHMpCgkJCXx8IHBrZy5mb3JtYXQgPT09ICdtYXZlbicKCQkJfHwgcGtnLmZvcm1hdCA9PT0gJ25wbScKCQkJfHwgcGtnLmZvcm1hdCA9PT0gJ3Jhdyc7Cgl9CgoJLyoqCgkgKiBSZXR1cm5zIHRoZSB2ZXJzaW9uIG9mIGEgcGFja2FnZS4KCSAqIE1ha2Ugc3VyZSB0aGUgcGFja2FnZSBpcyBzdXBwb3J0ZWQgaW4gdGhlIGFib3ZlIG1ldGhvZCBhcyB3ZWxsLgoJICovCgljb25zdCBwYWNrYWdlR2V0VmVyc2lvblRhZyA9IChwa2cpID0+IHsKCQlpZiAocGtnLmZvcm1hdCA9PT0gJ2RvY2tlcicgJiYgcGtnLnR5cGVfZGlzcGxheSA9PT0gJ21hbmlmZXN0L2xpc3QnKSB7CgkJCXJldHVybiBwa2c/LnRhZ3M/LnZlcnNpb24/LlswXTsKCQl9IGVsc2UgaWYgKHBrZy5mb3JtYXQgPT09ICdkb2NrZXInICYmIHBrZy50eXBlX2Rpc3BsYXkgPT09ICdpbWFnZScgJiYgIXBrZy5wYXJlbnQpIHsKCQkJcmV0dXJuIHBrZz8udGFncz8udmVyc2lvbj8uWzBdOwoJCX0gZWxzZSBpZiAocGtnLmZvcm1hdCA9PT0gJ21hdmVuJykgewoJCQlyZXR1cm4gcGtnPy5zdW1tYXJ5OwoJCX0gZWxzZSBpZiAocGtnLmZvcm1hdCA9PT0gJ25wbScpIHsKCQkJcmV0dXJuIHBrZz8udmVyc2lvbjsKCQl9IGVsc2UgaWYgKHBrZy5mb3JtYXQgPT09ICdyYXcnKSB7CgkJCXJldHVybiBwa2c/LnRhZ3M/LnZlcnNpb24/LlswXTsKCQl9Cgl9CgoJLyoqCgkgKiBGaWx0ZXIgYSBsaXN0IG9mIHBhY2thZ2VzIGJhc2VkIG9uIHRoZSBnbG9iYWwgb3B0aW9ucyAtZmlsdGVyLSBjcml0ZXJpYS4KCSAqCgkgKiBAcGFyYW0gcGFja2FnZXMgcGFja2FnZXMgdG8gZmlsdGVyCgkgKiBAcmV0dXJucyB7Kn0gbGlzdCBvZiBwYWNrYWdlcyB0aGF0IG1hdGNoIHRoZSBnbG9iYWwgb3B0aW9ucyBmaWx0ZXIgY3JpdGVyaWEuCgkgKi8KCWNvbnN0IHBhY2thZ2VzRmlsdGVyID0gKHBhY2thZ2VzKSA9PiB7CgkJcmV0dXJuIHBhY2thZ2VzLmZpbHRlcihwa2cgPT4gewoJCQkJLy8gRmlsdGVyIG9uIHN1cHBvcnRlZCBieSBzY3JpcHQKCQkJCWlmICghcGFja2FnZUlzU3VwcG9ydGVkKHBrZykpIHsKCQkJCQljb25zb2xlLmxvZygiRklMVEVSRUQ6IHVuc3VwcG9ydGVkOiAiICsgcGFja2FnZVRvU3RyaW5nKHBrZykpCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCS8vIEZpbHRlciBvbiBwYWNrYWdlIG5hbWUgcmVnZXguCgkJCQlpZiAoIXBrZy5uYW1lLm1hdGNoKGAke29wdGlvbnMucGtnX2ZpbHRlcl9uYW1lX3JlZ2V4fWApKSB7CgkJCQkJY29uc29sZS5sb2coIkZJTFRFUkVEOiBmaWx0ZXIgbmFtZSByZWdleCBub3QgbWF0Y2g6ICIgKyBwYWNrYWdlVG9TdHJpbmcocGtnKSkKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJLy8gRmlsdGVyIG9uIHBhY2thZ2UgZm9ybWF0IHJlZ2V4LgoJCQkJaWYgKCFwa2cuZm9ybWF0Lm1hdGNoKGAke29wdGlvbnMucGtnX2ZpbHRlcl9mb3JtYXRfcmVnZXh9YCkpIHsKCQkJCQljb25zb2xlLmxvZygiRklMVEVSRUQ6IGZvcm1hdCByZWdleCBub3QgbWF0Y2g6ICIgKyBwYWNrYWdlVG9TdHJpbmcocGtnKSkKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJLy8gQ2hlY2ssIHNob3VsZCB0aGUgcGFja2FnZSBoYXZlIGEgdGFnLCB3aGV0aGVyIGl0IG1hdGNoZXMuCgkJCQlpZiAocGFja2FnZUdldFZlcnNpb25UYWcocGtnKSAmJiAhcGFja2FnZUdldFZlcnNpb25UYWcocGtnKS5tYXRjaChgJHtvcHRpb25zLnBrZ19maWx0ZXJfdmVyc2lvbnRhZ19yZWdleH1gKSkgewoJCQkJCWNvbnNvbGUubG9nKCJGSUxURVJFRDogaGFzIHRhZyBidXQgcmVnZXggbm8gbWF0Y2g6ICIgKyBwYWNrYWdlVG9TdHJpbmcocGtnKSkKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJLy8gQ2hlY2ssIHNob3VsZCB0aGUgcGFja2FnZSBoYXMgTk8gdGFnLCB3aGV0aGVyIHdlIHdhbnQgdG8gcHJvY2VzcyBtaXNzaW5nIGl0ZW1zIHN0aWxsCgkJCQlpZiAoIXBhY2thZ2VHZXRWZXJzaW9uVGFnKHBrZykgJiYgIW9wdGlvbnMucGtnX2ZpbHRlcl92ZXJzaW9udGFnX3JlZ2V4X2FsbG93X21pc3NpbmcpIHsKCQkJCQljb25zb2xlLmxvZygiRklMVEVSRUQ6IG5vIHRhZyBhbmQgbm8gYWxsb3cgbWlzc2luZzogIiArIHBhY2thZ2VUb1N0cmluZyhwa2cpKQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQkvLyBDaGVjayBmb3IgZGF5cyBzaW5jZSB1cGxvYWQKCQkJCWNvbnN0IGRheXNTaW5jZVVwbG9hZGVkID0gKERhdGUubm93KCkgLSBEYXRlLnBhcnNlKHBrZy51cGxvYWRlZF9hdCkpIC8gODY0MDAgLyAxMDAwOwoJCQkJaWYgKHBhY2thZ2VHZXRWZXJzaW9uVGFnKHBrZykgJiYgZGF5c1NpbmNlVXBsb2FkZWQgPCBvcHRpb25zLnBrZ19kZWxldGVfdmVyc2lvbnRhZ19leGlzdHNfYWZ0ZXJfZGF5cykgewoJCQkJCWNvbnNvbGUubG9nKCJGSUxURVJFRDogdG9vIHlvdW5nIHdpdGggdGFnOiAiICsgcGFja2FnZVRvU3RyaW5nKHBrZykpCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCWlmICghcGFja2FnZUdldFZlcnNpb25UYWcocGtnKSAmJiBkYXlzU2luY2VVcGxvYWRlZCA8IG9wdGlvbnMucGtnX2RlbGV0ZV92ZXJzaW9udGFnX21pc3NpbmdfYWZ0ZXJfZGF5cykgewoJCQkJCWNvbnNvbGUubG9nKCJGSUxURVJFRDogdG9vIHlvdW5nIHdpdGhvdXQgdGFnOiAiICsgcGFja2FnZVRvU3RyaW5nKHBrZykpCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCS8vIENoZWNrIGlmIGl0J3MgdGhlIGxhdGVzdCBwYWNrYWdlCgkJCQljb25zdCBwYWNrYWdlc0xpc3QgPSBwYWNrYWdlcy5maWx0ZXIocCA9PiBwLm5hbWUgPT09IHBrZy5uYW1lKTsKCQkJCWNvbnN0IGlzTGF0ZXN0UGFja2FnZSA9IHBhY2thZ2VzTGlzdC5sZW5ndGggPT09IDEgPyB0cnVlIDogcGFja2FnZXNMaXN0LmV2ZXJ5KHAgPT4gRGF0ZS5wYXJzZShwa2cudXBsb2FkZWRfYXQpID49IERhdGUucGFyc2UocC51cGxvYWRlZF9hdCkpOwoJCQkJaWYgKGlzTGF0ZXN0UGFja2FnZSkgewoJCQkJICAgIGNvbnNvbGUubG9nKCJGSUxURVJFRDogTGF0ZXN0IHBhY2thZ2UgZm9yOiAiICsgcGFja2FnZVRvU3RyaW5nKHBrZykpOwoJCQkJICAgIHJldHVybiBmYWxzZTsKCQkJCX0KCQkJCgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCSk7Cgl9CgoJLyoqCgkgKiBSZXR1cm4gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgYSBzaW5nbGUgcGFja2FnZS4KCSAqIEBwYXJhbSBwa2cKCSAqIEByZXR1cm5zIHN0cmluZwoJICovCgljb25zdCBwYWNrYWdlVG9TdHJpbmcgPSAocGtnKSA9PiB7CgkJcmV0dXJuIGBbJHtwa2cuZm9ybWF0fXwke3BrZy50eXBlX2Rpc3BsYXl9XVske3BrZy5pZGVudGlmaWVyX3Blcm19XSAke3BrZy5uYW1lfToke3BhY2thZ2VHZXRWZXJzaW9uVGFnKHBrZykgfHwgJz8nfSAodXBsb2FkZWQ6ICR7bmV3IERhdGUocGtnLnVwbG9hZGVkX2F0KS50b0xvY2FsZVN0cmluZygnbmwnKX0pKCR7cHJldHR5Qnl0ZXMocGtnLnNpemUpfSlgOwoJfQoKCS8qKgoJICogUHJpbnQgYSBsaXN0IG9mIHBhY2thZ2VzLgoJICogQHBhcmFtIHBhY2thZ2VzCgkgKi8KCWNvbnN0IHByaW50UGFja2FnZXMgPSAocGFja2FnZXMpID0+IHsKCQlwYWNrYWdlcz8uZm9yRWFjaChwa2cgPT4gewoJCQljb25zb2xlLmxvZyhgXHQke3BhY2thZ2VUb1N0cmluZyhwa2cpfWApOwoJCQlwa2cuY2hpbGRyZW4/LmZvckVhY2goY2hpbGQgPT4gY29uc29sZS5sb2coYFx0XHQke3BhY2thZ2VUb1N0cmluZyhjaGlsZCl9YCkpCgkJfSkKCX0KCgkvKioKCSAqIFJldHVybnMgdGhlIHNpemUgb2YgYSBsaXN0IG9mIHBhY2thZ2VzCgkgKiBAcGFyYW0gcGtncyBwYWNrYWdlcwoJICogQHJldHVybnMge2ludH0gc2l6ZSBpbiBieXRlcwoJICovCglmdW5jdGlvbiBwYWNrYWdlc0dldFNpemUocGtncykgewoJCXJldHVybiBwa2dzLnJlZHVjZSgoYWNjLCBwa2cpID0+IGFjYyArIHBrZy5zaXplICsgcGFja2FnZXNHZXRTaXplKHBrZy5jaGlsZHJlbiB8fCBbXSksIDApCgl9CgoJLyoqCgkgKiBSdW4gdGhlIGNsb3Vkc21pdGggREVMRVRFIEFQSSBjYWxsIGZvciB0aGVzZSBwYWNrYWdlcy4KCSAqIEBwYXJhbSBwYWNrYWdlc1RvRGVsZXRlCgkgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0KCSAqLwoJY29uc3QgZGVsZXRlUGFja2FnZXMgPSBhc3luYyAocGFja2FnZXNUb0RlbGV0ZSkgPT4gewoJCWxldCBlcnI7CgoJCWZvciAoY29uc3QgcGtnIG9mIHBhY2thZ2VzVG9EZWxldGUpIHsKCQkJYXdhaXQgY2xvdWRzbWl0aC5kZWxldGUoYHBhY2thZ2VzLyR7b3B0aW9ucy5yZXBvX293bmVyfS8ke29wdGlvbnMucmVwb19uYW1lfS8ke3BrZy5pZGVudGlmaWVyX3Blcm19L2ApCgkJCQkudGhlbihyZXNwb25zZSA9PiB7CgkJCQkJY29uc29sZS5sb2coYERlbGV0ZWQ6ICR7cGFja2FnZVRvU3RyaW5nKHBrZyl9XG5cdD0+ICR7cmVzcG9uc2Uuc3RhdHVzfWApOwoJCQkJfSkuY2F0Y2gocmVzcG9uc2UgPT4gewoJCQkJCWVyciA9IGAke3Jlc3BvbnNlLnJlc3BvbnNlLnN0YXR1c30sICR7SlNPTi5zdHJpbmdpZnkocmVzcG9uc2UucmVzcG9uc2UuZGF0YSl9YDsKCQkJCQljb25zb2xlLmxvZyhgRmFpbGVkIHRvIGRlbGV0ZSBwYWNrYWdlOiAke3BhY2thZ2VUb1N0cmluZyhwa2cpfVxuXHRcdD0+ICR7ZXJyfWApOwoJCQkJfSk7CgkJCQoJCQkvL0RlbGV0ZSBhbGwgY2hpbGRyZW4gY29ubmVjdGVkIHRvIHRoaXMgcGFja2FnZQoJCQlpZiAocGtnLmNoaWxkcmVuKSB7CgkJCQlkZWxldGVQYWNrYWdlcyhwa2cuY2hpbGRyZW4pOwoJCQl9CgkJfQoKCQlpZiAoZXJyKSB7CgkJCXRocm93IGVycjsKCQl9Cgl9CgoKCWFzeW5jIGZ1bmN0aW9uIGdldERpZ2VzdHMocGtnLCB1cmwpIHsKCQljb25zdCB7ZGF0YX0gPSBhd2FpdCBjbG91ZHNtaXRoRG9ja2VyLmdldCh1cmwpCgkJCS5jYXRjaChlcnJvciA9PiB7CgkJCQlpZiAoZXJyb3IucmVzcG9uc2UgPT09IHVuZGVmaW5lZCB8fCBlcnJvci5yZXNwb25zZS5zdGF0dXMgIT09IDQwNCkgewoJCQkJCWNvbnNvbGUubG9nKGVycm9yKTsKCQkJCQl0aHJvdyBlcnJvcjsKCQkJCX0gZWxzZSB7CgkJCQkJY29uc29sZS5sb2coYE1hbmlmZXN0IGRhdGEgbm90IGZvdW5kIGZvcjogJHtwYWNrYWdlVG9TdHJpbmcocGtnKX1gKTsKCQkJCQlyZXR1cm4ge307CgkJCQl9CgkJCX0pOwoKCQlpZiAoZGF0YSA9PT0gdW5kZWZpbmVkIHx8IGRhdGEubWFuaWZlc3RzID09PSB1bmRlZmluZWQpIHsKCQkJY29uc29sZS5sb2coYE1hbmlmZXN0IGNvbnRhaW5zIG5vIGRhdGEgZm9yOiAke3BhY2thZ2VUb1N0cmluZyhwa2cpfWApOwoJCQlyZXR1cm4gW107CgkJfQoKCQlyZXR1cm4gZGF0YS5tYW5pZmVzdHMubWFwKG1hbmlmZXN0ID0+IG1hbmlmZXN0LmRpZ2VzdC5yZXBsYWNlKCdzaGEyNTY6JywgJycpKTsKCX0KCglhc3luYyBmdW5jdGlvbiBwYWNrYWdlc0FkZE1hbmlmZXN0KHBhY2thZ2VzKSB7CgkJLy9FeHRyYWN0IGFsbCB0aGUgZGlnZXN0cyBtZW50aW9uZWQgYnkgdGhlIHYyIG1hbmlmZXN0cwoJCWNvbnN0IGRvY2tlck1hbmlmZXN0cyA9IHBhY2thZ2VzLmZpbHRlcihwa2cgPT4gcGtnLmZvcm1hdCA9PT0gJ2RvY2tlcicgJiYgcGtnLnR5cGVfZGlzcGxheSA9PT0gJ21hbmlmZXN0L2xpc3QnKTsKCgkJY29uc3QgY2h1bmtTaXplID0gMjU7CgkJZm9yIChsZXQgaSA9IDA7IGkgPCBkb2NrZXJNYW5pZmVzdHMubGVuZ3RoOyBpICs9IGNodW5rU2l6ZSkgewoJCQljb25zdCBtYW5pZmVzdENodW5rID0gZG9ja2VyTWFuaWZlc3RzLnNsaWNlKGksIGkgKyBjaHVua1NpemUpOwoKCQkJLy8gQ3JlYXRlIGEgYmF0Y2ggb2YgcmVxdWVzdHMKCQkJY29uc3QgYmF0Y2ggPSBuZXcgTWFwKCk7CgkJCWZvciAoY29uc3QgbWFuaWZlc3RQa2cgb2YgbWFuaWZlc3RDaHVuaykgewoJCQkJYmF0Y2guc2V0KG1hbmlmZXN0UGtnLCBnZXREaWdlc3RzKG1hbmlmZXN0UGtnLCBgJHttYW5pZmVzdFBrZy5uYW1lc3BhY2V9LyR7bWFuaWZlc3RQa2cucmVwb3NpdG9yeX0vJHttYW5pZmVzdFBrZy5uYW1lfS9tYW5pZmVzdHMvc2hhMjU2OiR7bWFuaWZlc3RQa2cudmVyc2lvbn1gKSk7CgkJCX0KCgkJCS8vIFByb2Nlc3MgZWFjaCBiYXRjaCBvZiByZXF1ZXN0cwoJCQlmb3IgKGNvbnN0IFttYW5pZmVzdFBrZywgbWFuaWZlc3RSZXF1ZXN0XSBvZiBiYXRjaCkgewoJCQkJY29uc3QgZGlnZXN0cyA9IGF3YWl0IG1hbmlmZXN0UmVxdWVzdDsKCQkJCW1hbmlmZXN0UGtnLmNoaWxkcmVuID0gcGFja2FnZXMuZmlsdGVyKHBrZyA9PiBwa2cuZm9ybWF0ID09PSAnZG9ja2VyJyAmJiBkaWdlc3RzLmluY2x1ZGVzKHBrZy52ZXJzaW9uKSk7CgkJCQltYW5pZmVzdFBrZy5jaGlsZHJlbi5mb3JFYWNoKHBrZyA9PiBwa2cucGFyZW50ID0gbWFuaWZlc3RQa2cpCgkJCX0KCQl9Cgl9CgoJLyoqCgkgKiBNYWluIGZ1bmN0aW9uIG9mIHRoaXMgbW9kdWxlCgkgKiovCglhc3luYyBmdW5jdGlvbiBydW4oKSB7CgkJY29uc3QgcGFja2FnZXMgPSBhd2FpdCBmZXRjaFBhY2thZ2VzKG9wdGlvbnMucGtnX2FwaV9mZXRjaF9xdWVyeSk7CgkJcGFja2FnZXNWYWxpZGF0ZShwYWNrYWdlcyk7CgoJCWNvbnNvbGUubG9nKGBBZGRpbmcgbWFuaWZlc3RzIGZvciBkb2NrZXIuLi5gKTsKCQlhd2FpdCBwYWNrYWdlc0FkZE1hbmlmZXN0KHBhY2thZ2VzKTsKCgkJY29uc3QgcGFja2FnZXNUb0RlbGV0ZSA9IHBhY2thZ2VzRmlsdGVyKHBhY2thZ2VzKTsKCQljb25zb2xlLmxvZyhgUGFja2FnZXMgdG8gYmUgZGVsZXRlZDogJHtwYWNrYWdlc1RvRGVsZXRlLmxlbmd0aH0gKCR7cHJldHR5Qnl0ZXMocGFja2FnZXNHZXRTaXplKHBhY2thZ2VzVG9EZWxldGUpKX0pYCk7CgkJcHJpbnRQYWNrYWdlcyhwYWNrYWdlc1RvRGVsZXRlKTsKCgkJaWYgKG9wdGlvbnMuZHJ5X3J1bikgewoJCQljb25zb2xlLmxvZygnQWJvcnRpbmcgZHVlIHRvIGRyeSBydW4uJykKCQkJcmV0dXJuOwoJCX0KCgkJYXdhaXQgZGVsZXRlUGFja2FnZXMocGFja2FnZXNUb0RlbGV0ZSk7CgoJCWNvbnNvbGUubG9nKCdEb25lIScpOwoJfQoKCXJldHVybiBhd2FpdCBydW4oKTsKfQoKZXhwb3J0IGZ1bmN0aW9uIE9wdGlvbnMoKSB7Cgl0aGlzLmRyeV9ydW4gPSB0cnVlOwoJdGhpcy5yZXBvX25hbWUgPSAnJzsKCXRoaXMucmVwb19vd25lciA9ICcnOwoJdGhpcy5wa2dfYXBpX2ZldGNoX3F1ZXJ5ID0gJyc7Cgl0aGlzLnBrZ19maWx0ZXJfbmFtZV9yZWdleCA9ICdeLiokJzsKCXRoaXMucGtnX2ZpbHRlcl9mb3JtYXRfcmVnZXggPSAnXi4qJCc7Cgl0aGlzLnBrZ19maWx0ZXJfcHJvY2Vzc19kb2NrZXJpbWFnZV93aXRob3V0X3BhcmVudHMgPSBmYWxzZTsKCXRoaXMucGtnX2ZpbHRlcl92ZXJzaW9udGFnX3JlZ2V4ID0gJ14uKy1TTkFQU0hPVCQnOwoJdGhpcy5wa2dfZmlsdGVyX3ZlcnNpb250YWdfcmVnZXhfYWxsb3dfbWlzc2luZyA9IGZhbHNlOwoJdGhpcy5wa2dfZGVsZXRlX3ZlcnNpb250YWdfZXhpc3RzX2FmdGVyX2RheXMgPSAzMDsKCXRoaXMucGtnX2RlbGV0ZV92ZXJzaW9udGFnX21pc3NpbmdfYWZ0ZXJfZGF5cyA9IDMwOwoJdGhpcy5jbG91ZHNtaXRoX3VzZXJuYW1lID0gJyc7Cgl0aGlzLmNsb3Vkc21pdGhfYXBpX2tleSA9ICcnOwoJdGhpcy5jbG91ZHNtaXRoX2RvY2tlcl9yZWdpc3RyeSA9ICcnOwoKCXRoaXMucHJpbnQgPSAoKSA9PiB7CgkJY29uc29sZS5sb2coIk9wdGlvbnM6ICIpCgkJY29uc29sZS5sb2coYFx0ZHJ5X3J1biA9ICR7dGhpcy5kcnlfcnVufVxuYCk7CgkJY29uc29sZS5sb2coYFx0cmVwb19uYW1lID0gJHt0aGlzLnJlcG9fbmFtZX1gKTsKCQljb25zb2xlLmxvZyhgXHRyZXBvX293bmVyID0gJHt0aGlzLnJlcG9fb3duZXJ9XG5gKTsKCQljb25zb2xlLmxvZyhgXHRwa2dfYXBpX2ZldGNoX3F1ZXJ5ID0gJHt0aGlzLnBrZ19hcGlfZmV0Y2hfcXVlcnl9XG5gKTsKCQljb25zb2xlLmxvZyhgXHRwa2dfZmlsdGVyX25hbWVfcmVnZXggPSAke3RoaXMucGtnX2ZpbHRlcl9uYW1lX3JlZ2V4fWApOwoJCWNvbnNvbGUubG9nKGBcdHBrZ19maWx0ZXJfZm9ybWF0X3JlZ2V4ID0gJHt0aGlzLnBrZ19maWx0ZXJfZm9ybWF0X3JlZ2V4fWApOwoJCWNvbnNvbGUubG9nKGBcdHBrZ19maWx0ZXJfcHJvY2Vzc19kb2NrZXJpbWFnZV93aXRob3V0X3BhcmVudHMgPSAke3RoaXMucGtnX2ZpbHRlcl9wcm9jZXNzX2RvY2tlcmltYWdlX3dpdGhvdXRfcGFyZW50c31cbmApOwoJCWNvbnNvbGUubG9nKGBcdHBrZ19maWx0ZXJfdmVyc2lvbnRhZ19yZWdleCA9ICR7dGhpcy5wa2dfZmlsdGVyX3ZlcnNpb250YWdfcmVnZXh9YCk7CgkJY29uc29sZS5sb2coYFx0cGtnX2ZpbHRlcl92ZXJzaW9udGFnX3JlZ2V4X2FsbG93X21pc3NpbmcgPSAke3RoaXMucGtnX2ZpbHRlcl92ZXJzaW9udGFnX3JlZ2V4X2FsbG93X21pc3Npbmd9XG5gKTsKCQljb25zb2xlLmxvZyhgXHRwa2dfZGVsZXRlX3ZlcnNpb250YWdfZXhpc3RzX2FmdGVyX2RheXMgPSAke3RoaXMucGtnX2RlbGV0ZV92ZXJzaW9udGFnX2V4aXN0c19hZnRlcl9kYXlzfWApOwoJCWNvbnNvbGUubG9nKGBcdHBrZ19kZWxldGVfdmVyc2lvbnRhZ19taXNzaW5nX2FmdGVyX2RheXMgPSAke3RoaXMucGtnX2RlbGV0ZV92ZXJzaW9udGFnX21pc3NpbmdfYWZ0ZXJfZGF5c31cbmApOwoJCWNvbnNvbGUubG9nKGBcdGNsb3Vkc21pdGhfdXNlcm5hbWUgPSAke3RoaXMuY2xvdWRzbWl0aF91c2VybmFtZX1cbmApOwoJCWNvbnNvbGUubG9nKGBcdGNsb3Vkc21pdGhfYXBpX2tleSA9ICR7dGhpcy5jbG91ZHNtaXRoX2FwaV9rZXl9XG5gKTsKCQljb25zb2xlLmxvZyhgXHRjbG91ZHNtaXRoX2RvY2tlcl9yZWdpc3RyeSA9ICR7dGhpcy5jbG91ZHNtaXRoX2RvY2tlcl9yZWdpc3RyeX1cbmApOwoJfQp9" | base64 --decode > ${{ github.workspace }}/action.mjs
    #  shell: bash
    - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const { clean, Options } = await import('${{ github.workspace }}/action.mjs');
          let options = new Options();
          options.cloudsmith_username = '${{ inputs.cloudsmith_username }}';
          options.cloudsmith_api_key = '${{ inputs.cloudsmith_api_key }}';
          options.repo_name = '${{ inputs.repo_name }}';
          options.repo_owner = '${{ inputs.repo_owner }}';
          options.cloudsmith_docker_registry = '${{ inputs.cloudsmith_docker_registry }}';
          options.pkg_api_fetch_query = '${{ inputs.pkg_api_fetch_query }}';
          options.pkg_filter_name_regex = '${{ inputs.pkg_filter_name_regex }}';
          options.pkg_filter_format_regex = '${{ inputs.pkg_filter_format_regex }}';
          options.pkg_filter_process_dockerimage_without_parents = ('${{ inputs.pkg_filter_process_dockerimage_without_parents }}' === 'true'); 
          options.pkg_filter_versiontag_regex = '${{ inputs.pkg_filter_versiontag_regex }}';
          options.pkg_filter_versiontag_regex_allow_missing = '${{ inputs.pkg_filter_versiontag_regex_allow_missing }}';
          options.pkg_delete_versiontag_exists_after_days = '${{ inputs.pkg_delete_versiontag_exists_after_days }}';
          options.pkg_delete_versiontag_missing_after_days = '${{ inputs.pkg_delete_versiontag_missing_after_days }}';
          options.dry_run = !('${{ inputs.dry_run }}' === 'false'); // Explicitly keep the dry_run unless an exact 'false' value is given.
          options.print();
          
          try {
            await clean(options);
          } catch(err) {
            core.setFailed(err);
          }
